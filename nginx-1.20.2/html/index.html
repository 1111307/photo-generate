<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片文字合成系统</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --primary-light: #5f7fff;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --success-dark: #38b2e0;
            --warning: #f72585;
            --danger: #e63946;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            color: var(--dark);
            padding: 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 24px;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .main-content {
            flex: 1;
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .tab {
            padding: 20px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            transition: var(--transition);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .tab.active {
            color: var(--primary);
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        .tab-content {
            padding: 40px;
            line-height: 1.8;
        }

        .form-group {
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .form-label {
            display: block;
            margin-bottom: 12px;
            color: var(--gray-800);
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        .form-control {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-sm);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            background: white;
            line-height: 1.6;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .file-upload {
            border: 3px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--gray-100);
            position: relative;
            z-index: 1;
        }

        .file-upload input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .file-upload i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .file-upload p {
            color: var(--gray-700);
            font-weight: 500;
            margin: 5px 0;
        }

        .file-upload .hint {
            font-size: 12px;
            color: var(--gray-500);
        }

        .preview-section {
            margin-top: 30px;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
            letter-spacing: 0.3px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .preview-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--gray-200);
        }

        .preview-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--gray-100);
        }

        .preview-text {
            padding: 15px;
            font-size: 14px;
            color: var(--gray-700);
            text-align: center;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .stat-value {
            font-size: 38px;
            font-weight: 700;
            line-height: 1.2;
        }

        .table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-100);
            padding: 16px 15px;
            text-align: left;
            color: var(--gray-700);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 16px 15px;
            color: var(--gray-700);
            font-size: 14px;
            border-bottom: 1px solid var(--gray-200);
            line-height: 1.6;
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 30px;
            padding: 30px 20px 20px;
        }

        .page-info {
            color: var(--gray-600);
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .message {
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 25px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success-dark);
            border-left: 4px solid var(--success);
        }

        .message.error {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            padding: 0 10px;
        }

        .single-generate-btn {
            margin-left: 10px;
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            z-index: 10000;
        }

        .close-modal:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        .modal-caption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            height: 150px;
        }

        .preview-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--gray-200);
            cursor: pointer;
        }

        .preview-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .preview-card:hover .preview-image {
            transform: scale(1.05);
        }

        .preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--gray-100);
            transition: var(--transition);
        }

        .logout-modal {
            display: none;
            position: fixed;
            z-index: 9998;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .logout-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logout-modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logout-modal-icon {
            font-size: 48px;
            color: var(--success);
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .logout-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .logout-modal-message {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease 0.3s both;
        }

        .logout-modal-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(76, 201, 240, 0.3);
            border-radius: 50%;
            border-top-color: var(--success);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .account-modal {
            display: none;
            position: fixed;
            z-index: 9997;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .account-modal.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
        }

        .account-modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 40px;
            max-width: 900px;
            width: 90%;
            animation: slideUp 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .account-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .account-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .account-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .account-modal-close:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        .account-modal-logout-btn {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 15px;
        }

        .account-modal-logout-btn .btn {
            flex: 1;
            padding: 10px 16px;
            font-size: 14px;
        }

        .account-tab-content {
            display: block;
            padding: 20px 0;
        }

        .admin-tab {
            display: block;
        }
        
        #account-tabs {
            margin-bottom: 20px;
        }
        
        #admin-tab-content .tabs {
            margin-bottom: 20px;
        }
        
        .tab-content {
            padding: 20px 0;
        }

        .login-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .login-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .login-modal-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease;
        }

        .login-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .login-modal-message {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease 0.3s both;
        }

        .login-modal-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 15px;
                height: 60px;
            }

            .logo h1 {
                font-size: 20px;
            }

            .tab-content {
                padding: 25px;
            }

            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-image logo-icon"></i>
                    <h1>图片文字合成系统</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <button class="btn btn-outline" onclick="goToAccount()" id="username-btn">
                        <i class="fas fa-user"></i>我的账户
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='login.html'" id="login-btn" style="display: none;">
                        <i class="fas fa-sign-in-alt"></i>登录
                    </button>
                    <button class="btn btn-outline" onclick="window.location.href='register.html'" id="register-btn" style="display: none;">
                        <i class="fas fa-user-plus"></i>注册
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="dashboard-card">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('single')">
                        <i class="fas fa-file-image"></i>单次生成
                    </button>
                    <button class="tab" onclick="switchTab('batch')">
                        <i class="fas fa-layer-group"></i>批量生成
                    </button>
                    <button class="tab" onclick="switchTab('add-template')">
                        <i class="fas fa-plus"></i>添加模板
                    </button>
                </div>

                <div class="tab-content">
                    <div class="message" id="message"></div>

                    <!-- 单次生成 -->
                    <div id="single-tab">
                        <div class="form-group">
                            <label class="form-label" for="template-select">
                                <i class="fas fa-palette"></i>选择模板
                            </label>
                            <select class="form-control" id="template-select"></select>
                        </div>
                        <div class="form-group" id="single-template-preview" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-eye"></i>模板预览
                            </label>
                            <div style="text-align: center; border: 2px dashed var(--gray-300); border-radius: var(--border-radius); padding: 20px; position: relative; overflow: auto; max-height: 600px;">
                                <div style="position: relative; display: inline-block;">
                                    <img id="single-template-image" src="" alt="模板预览" style="max-width: 25%; border-radius: var(--border-radius-sm); display: block;">
                                    <canvas id="single-template-canvas" style="position: absolute; top: 0; left: 0; cursor: crosshair;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="single-text">
                                <i class="fas fa-font"></i>输入文字
                            </label>
                            <textarea class="form-control" id="single-text" placeholder="请输入要合成的文字..."></textarea>
                        </div>
                        <button class="btn btn-primary single-generate-btn" onclick="generateSingle()">
                            <i class="fas fa-magic"></i>生成图片
                        </button>
                        
                        <div class="preview-section" id="single-preview-section" style="display: none;">
                            <div class="preview-title">
                                <i class="fas fa-eye"></i>预览结果
                            </div>
                            <div class="preview-grid" id="single-preview"></div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="exportSingleImage()" id="single-export-btn">
                                    <i class="fas fa-download"></i>导出图片
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 批量生成 -->
                    <div id="batch-tab" class="hidden">
                        <div class="form-group">
                            <label class="form-label" for="batch-template-select">
                                <i class="fas fa-palette"></i>选择模板
                            </label>
                            <select class="form-control" id="batch-template-select"></select>
                        </div>
                        <div class="form-group" id="batch-template-preview" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-eye"></i>模板预览
                            </label>
                            <div style="text-align: center; border: 2px dashed var(--gray-300); border-radius: var(--border-radius); padding: 20px; position: relative; overflow: auto; max-height: 600px;">
                                <div style="position: relative; display: inline-block;">
                                    <img id="batch-template-image" src="" alt="模板预览" style="max-width: 25%; border-radius: var(--border-radius-sm); display: block;">
                                    <canvas id="batch-template-canvas" style="position: absolute; top: 0; left: 0; cursor: crosshair;"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-font"></i>批量文字（每行一条）
                            </label>
                            <textarea class="form-control" id="batch-text" placeholder="请输入要合成的文字，每行一条..."></textarea>
                            <button class="btn btn-primary" onclick="generateBatch()" style="margin-top: 15px;">
                                <i class="fas fa-magic"></i>批量生成
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-excel"></i>或上传Excel文件
                            </label>
                            <div class="file-upload" id="excel-upload-area">
                                <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleExcelUpload()">
                                <i class="fas fa-file-upload"></i>
                                <p>点击上传Excel文件</p>
                                <p class="hint">Excel文件第一列为文字内容</p>
                            </div>
                        </div>
                        
                        <div class="preview-section" id="batch-preview-section" style="display: none;">
                            <div class="preview-title">
                                <i class="fas fa-eye"></i>预览结果
                            </div>
                            <div class="preview-grid" id="batch-preview"></div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="exportImages()" id="batch-export-btn">
                                    <i class="fas fa-download"></i>导出图片
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- 添加模板 -->
                    <div id="add-template-tab" class="hidden">
                        <div class="form-group">
                            <label class="form-label" for="template-name">
                                <i class="fas fa-tag"></i>模板名称
                            </label>
                            <input type="text" class="form-control" id="template-name" placeholder="请输入模板名称...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-image"></i>上传模板图片
                            </label>
                            <div class="file-upload" id="template-upload-area">
                                <input type="file" id="template-file" accept="image/*" onchange="handleTemplateImageUpload()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>点击上传模板图片</p>
                                <p class="hint">支持 JPG、PNG 等图片格式</p>
                            </div>
                        </div>

                        <div class="form-group" id="template-preview-section" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-eye"></i>图片预览
                            </label>
                            <div style="display: flex; gap: 15px; align-items: flex-start;">
                                <div style="flex: 1; text-align: center; border: 2px dashed var(--gray-300); border-radius: var(--border-radius); padding: 20px; position: relative; overflow: auto; max-height: 600px;">
                                    <div style="position: relative; display: inline-block;">
                                        <img id="template-preview-img" src="" alt="模板预览" style="max-width: 100%; border-radius: var(--border-radius-sm); display: block;">
                                        <canvas id="template-preview-canvas" style="position: absolute; top: 0; left: 0; cursor: crosshair;"></canvas>
                                    </div>
                                </div>
                                <div style="width: 200px;">
                                    <div style="padding: 15px; background: var(--gray-100); border-radius: var(--border-radius-sm);">
                                        <p style="font-size: 12px; color: var(--gray-600); margin-bottom: 10px;"><strong>文字预览</strong></p>
                                        <div id="font-size-preview" style="width: 100%; height: 80px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                            <span id="preview-text" style="font-weight: bold;">文字区域</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="template-coordinates-info" style="margin-top: 15px; padding: 15px; background: var(--gray-100); border-radius: var(--border-radius-sm); text-align: left; font-size: 13px; color: var(--gray-700);">
                                <p><strong>在图片上拖动鼠标标注文字区域：</strong></p>
                                <p id="coord-display">请在图片上拖动鼠标来标注文字区域</p>
                            </div>
                        </div>

                        <div class="form-group" id="text-area-settings" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-sliders-h"></i>文字区域设置
                            </label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label class="form-label" style="font-size: 13px;">X坐标</label>
                                    <input type="number" class="form-control" id="text-x" value="0" min="0">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px;">Y坐标</label>
                                    <input type="number" class="form-control" id="text-y" value="0" min="0">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px;">宽度</label>
                                    <input type="number" class="form-control" id="text-width" value="0" min="0">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px;">高度</label>
                                    <input type="number" class="form-control" id="text-height" value="0" min="0">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px;">覆盖颜色</label>
                                    <input type="color" class="form-control" id="cover-color" value="#ffffff" style="height: 45px; cursor: pointer;">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px;">字体大小</label>
                                    <input type="number" class="form-control" id="font-size" value="37" min="8" max="72" onchange="updateFontSizePreview()" oninput="updateFontSizePreview()">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px;">字体颜色</label>
                                    <input type="color" class="form-control" id="font-color" value="#000000" style="height: 45px; cursor: pointer;" onchange="updateFontSizePreview()" oninput="updateFontSizePreview()">
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="submitTemplate()">
                                <i class="fas fa-save"></i>保存模板
                            </button>
                        </div>

                        <!-- 我的模板列表 -->
                        <div class="preview-section" style="margin-top: 50px;">
                            <div class="preview-title">
                                <i class="fas fa-list"></i>我的模板
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>模板名称</th>
                                            <th>创建时间</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-templates-tbody">
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 20px;">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination">
                                <button class="btn btn-outline" onclick="previousMyTemplatesPage()">
                                    <i class="fas fa-chevron-left"></i>上一页
                                </button>
                                <span class="page-info" id="my-templates-page-info">第 1 页</span>
                                <button class="btn btn-outline" onclick="nextMyTemplatesPage()">
                                    下一页<i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 图片查看模态框 -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="modalCaption" class="modal-caption"></div>
    </div>
    <!-- 登出模态框 -->
    <div id="logoutModal" class="logout-modal">
        <div class="logout-modal-content">
            <div class="logout-modal-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <div class="logout-modal-title">正在登出...</div>
            <div class="logout-modal-message">请稍候，正在安全退出您的账户</div>
            <div class="logout-modal-spinner"></div>
        </div>
    </div>

    <!-- 账户模态框 -->
    <div id="accountModal" class="account-modal">
        <div class="account-modal-content">
            <div class="account-modal-header">
                <div class="account-modal-title">我的账户</div>
                <button class="account-modal-close" onclick="closeAccountModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 标签页按钮 -->
            <div id="account-tabs" class="tabs">
                <button class="tab active" onclick="switchAccountTab('user')">
                    <i class="fas fa-user"></i>个人信息
                </button>
                <button class="tab" id="admin-tab" onclick="switchAccountTab('admin')" style="display: none;">
                    <i class="fas fa-cog"></i>管理员控制面板
                </button>
            </div>
            
            <!-- 个人信息标签页 -->
            <div id="user-tab-content" class="account-tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-calendar-day stat-icon"></i>
                        <div class="stat-label">今日生成</div>
                        <div class="stat-value" id="modal-today-count">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt stat-icon"></i>
                        <div class="stat-label">本月生成</div>
                        <div class="stat-value" id="modal-month-count">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <div class="stat-label">总计生成</div>
                        <div class="stat-value" id="modal-total-count">0</div>
                    </div>
                </div>

                <div class="preview-title">
                    <i class="fas fa-list"></i>使用明细
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>生成时间</th>
                                <th>模板</th>
                                <th>数量</th>
                                <th>文字内容</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="modal-usage-records">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px;">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button class="btn btn-outline" onclick="previousModalPage()">
                        <i class="fas fa-chevron-left"></i>上一页
                    </button>
                    <span class="page-info" id="modal-page-info">第 1 页</span>
                    <button class="btn btn-outline" onclick="nextModalPage()">
                        下一页<i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- 管理员控制面板标签页 -->
            <div id="admin-tab-content" class="account-tab-content" style="display: none;">
                <div class="tabs">
                    <button class="tab active" onclick="switchAdminTab('statistics')">
                        <i class="fas fa-chart-bar"></i>统计信息
                    </button>
                    <button class="tab" onclick="switchAdminTab('users')">
                        <i class="fas fa-users"></i>用户管理
                    </button>
                    <button class="tab" onclick="switchAdminTab('records')">
                        <i class="fas fa-history"></i>使用记录
                    </button>
                </div>
                
                <!-- 统计信息 -->
                <div id="admin-statistics" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users stat-icon"></i>
                            <div class="stat-label">总用户数</div>
                            <div class="stat-value" id="admin-user-count">0</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-line stat-icon"></i>
                            <div class="stat-label">总生成数</div>
                            <div class="stat-value" id="admin-total-generate">0</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-calendar-day stat-icon"></i>
                            <div class="stat-label">今日生成</div>
                            <div class="stat-value" id="admin-today-generate">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- 用户管理 -->
                <div id="admin-users" class="tab-content" style="display: none;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>邮箱</th>
                                    <th>电话</th>
                                    <th>角色</th>
                                    <th>创建时间</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-tbody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button class="btn btn-outline" onclick="previousAdminUsersPage()">
                            <i class="fas fa-chevron-left"></i>上一页
                        </button>
                        <span class="page-info" id="admin-users-page-info">第 1 页</span>
                        <button class="btn btn-outline" onclick="nextAdminUsersPage()">
                            下一页<i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 使用记录 -->
                <div id="admin-records" class="tab-content" style="display: none;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>生成时间</th>
                                    <th>模板</th>
                                    <th>数量</th>
                                    <th>文字内容</th>
                                </tr>
                            </thead>
                            <tbody id="admin-records-tbody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button class="btn btn-outline" onclick="previousAdminRecordsPage()">
                            <i class="fas fa-chevron-left"></i>上一页
                        </button>
                        <span class="page-info" id="admin-records-page-info">第 1 页</span>
                        <button class="btn btn-outline" onclick="nextAdminRecordsPage()">
                            下一页<i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="account-modal-logout-btn">
                <button class="btn btn-primary" onclick="openChangePasswordModal()">
                    <i class="fas fa-key"></i>修改密码
                </button>
                <button class="btn btn-primary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>退出登录
                </button>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="account-modal">
        <div class="account-modal-content">
            <div class="account-modal-header">
                <div class="account-modal-title">修改密码</div>
                <button class="account-modal-close" onclick="closeChangePasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="account-tab-content">
                <div class="message" id="change-password-message"></div>
                
                <div class="form-group">
                    <label class="form-label" for="old-password">
                        <i class="fas fa-lock"></i>原密码
                    </label>
                    <input type="password" class="form-control" id="old-password" placeholder="请输入原密码">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="new-password">
                        <i class="fas fa-lock"></i>新密码
                    </label>
                    <input type="password" class="form-control" id="new-password" placeholder="请输入新密码（至少8个字符）">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="confirm-password">
                        <i class="fas fa-lock"></i>确认密码
                    </label>
                    <input type="password" class="form-control" id="confirm-password" placeholder="请再次输入新密码">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="submitChangePassword()" style="flex: 1;">
                        <i class="fas fa-save"></i>确认修改
                    </button>
                    <button class="btn btn-outline" onclick="closeChangePasswordModal()" style="flex: 1;">
                        <i class="fas fa-times"></i>取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <div class="login-modal-icon">
                <i class="fas fa-sign-in-alt"></i>
            </div>
            <div class="login-modal-title">正在登录...</div>
            <div class="login-modal-message">请稍候，正在验证您的身份</div>
            <div class="login-modal-spinner"></div>
        </div>
    </div>


    <script>
        let currentImages = [];
        let token = localStorage.getItem('token');
        let currentPage = 1;
        let totalPages = 1;
        let modalCurrentPage = 1;
        let modalTotalPages = 1;
        let isLoggedIn = !!token;
        let templates = []; // 保存模板数据
        let userRole = localStorage.getItem('role'); // 获取用户角色
        let adminCurrentPage = 1;
        let adminTotalPages = 1;

        // 初始化页面
        function initPage() {
            const username = localStorage.getItem('username');
            userRole = localStorage.getItem('role'); // 读取role
             
            if (isLoggedIn) {
                // 已登录状态
                document.getElementById('user-avatar').textContent = username ? username.charAt(0).toUpperCase() : 'U';
                document.getElementById('username-btn').innerHTML = `<i class="fas fa-user"></i>${username || '用户'}`;
                document.getElementById('username-btn').style.display = 'inline-flex';
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('register-btn').style.display = 'none';
                // 允许input接收点击事件
                document.getElementById('excel-file').style.pointerEvents = 'auto';
            } else {
                // 未登录状态
                document.getElementById('user-avatar').style.display = 'none';
                document.getElementById('username-btn').innerHTML = `<i class="fas fa-user"></i>未登录`;
                document.getElementById('username-btn').style.display = 'inline-flex';
                document.getElementById('login-btn').style.display = 'inline-flex';
                document.getElementById('register-btn').style.display = 'inline-flex';
                // 阻止input接收点击事件
                document.getElementById('excel-file').style.pointerEvents = 'none';
                
                // 隐藏管理员按钮
                const adminTab = document.getElementById('admin-tab');
                if (adminTab) {
                    adminTab.style.display = 'none';
                }
            }
        }

        initPage();

        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).then(response => {
                // 对于公开接口（如获取模板列表），401不触发重定向
                const url = args[0];
                if (response.status === 401 && !url.includes('/api/photo/templates')) {
                    handle401Error();
                }
                return response;
            });
        };

        function handle401Error() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            isLoggedIn = false;
            token = null;
            userRole = null;
            
            // 关闭所有模态框
            const accountModal = document.getElementById('accountModal');
            if (accountModal) {
                accountModal.classList.remove('show');
            }
            
            const imageModal = document.getElementById('imageModal');
            if (imageModal) {
                imageModal.style.display = 'none';
            }
            
            // 清空模板下拉框
            document.getElementById('template-select').innerHTML = '<option value="">请选择模板</option>';
            document.getElementById('batch-template-select').innerHTML = '<option value="">请选择模板</option>';
            templates = [];
            
            // 隐藏模板预览
            document.getElementById('single-template-preview').style.display = 'none';
            document.getElementById('batch-template-preview').style.display = 'none';
            
            // 清空预览结果
            document.getElementById('single-preview').innerHTML = '';
            document.getElementById('batch-preview').innerHTML = '';
            document.getElementById('single-preview-section').style.display = 'none';
            document.getElementById('batch-preview-section').style.display = 'none';
            
            // 清空预览图片src
            document.getElementById('single-template-image').src = '';
            document.getElementById('batch-template-image').src = '';
            
            // 清空所有表单输入
            document.getElementById('single-text').value = '';
            document.getElementById('batch-text').value = '';
            document.getElementById('template-name').value = '';
            document.getElementById('template-file').value = '';
            document.getElementById('excel-file').value = '';
            
            // 清空模板预览表单
            document.getElementById('template-preview-img').src = '';
            document.getElementById('template-preview-section').style.display = 'none';
            document.getElementById('text-area-settings').style.display = 'none';
            document.getElementById('text-x').value = '0';
            document.getElementById('text-y').value = '0';
            document.getElementById('text-width').value = '0';
            document.getElementById('text-height').value = '0';
            document.getElementById('font-size').value = '37';
            document.getElementById('font-color').value = '#000000';
            document.getElementById('coord-display').textContent = '请在图片上点击并拖动来标注文字区域';
            
            // 清空所有表格数据
            document.getElementById('modal-usage-records').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载中...</td></tr>';
            document.getElementById('my-templates-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">加载中...</td></tr>';
            document.getElementById('admin-users-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载中...</td></tr>';
            document.getElementById('admin-records-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载中...</td></tr>';
            
            // 重置分页信息
            document.getElementById('modal-page-info').textContent = '第 1 页';
            document.getElementById('my-templates-page-info').textContent = '第 1 页';
            document.getElementById('admin-users-page-info').textContent = '第 1 页';
            document.getElementById('admin-records-page-info').textContent = '第 1 页';
            
            // 重置统计数据
            document.getElementById('modal-today-count').textContent = '0';
            document.getElementById('modal-month-count').textContent = '0';
            document.getElementById('modal-total-count').textContent = '0';
            document.getElementById('admin-user-count').textContent = '0';
            document.getElementById('admin-total-generate').textContent = '0';
            document.getElementById('admin-today-generate').textContent = '0';
            
            // 重置标签页状态
            currentPage = 1;
            totalPages = 1;
            modalCurrentPage = 1;
            modalTotalPages = 1;
            adminCurrentPage = 1;
            adminTotalPages = 1;
            myTemplatesCurrentPage = 1;
            myTemplatesTotalPages = 1;
            currentImages = [];
            isDrawing = false;
            
            // 更新UI为未登录状态
            initPage();
            
            // 显示提示信息
            showMessage('登录已过期，请重新登录', 'error');
        }

        async function loadTemplates() {
            try {
                const headers = {};
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                const response = await fetch('/api/photo/templates', { headers });
                const result = await response.json();
                
                if (result.code === 200) {
                    templates = result.data; // 保存模板数据
                    
                    // 添加默认选项
                    const defaultOption = '<option value="">请选择模板</option>';
                    const options = templates.map(t => `<option value="${t.id}">${t.templateName}</option>`).join('');
                    document.getElementById('template-select').innerHTML = defaultOption + options;
                    document.getElementById('batch-template-select').innerHTML = defaultOption + options;
                    
                    // 模板加载完成后，绑定事件监听器
                    bindTemplateChangeEvents();
                }
            } catch (error) {
                showMessage('加载模板失败', 'error');
            }
        }
        
        // 绑定模板选择变化事件
        function bindTemplateChangeEvents() {
            // 单次生成模板选择变化事件
            document.getElementById('template-select').addEventListener('change', function() {
                const templateId = this.value;
                showTemplatePreview(templateId, 'single-template-preview', 'single-template-image');
            });
            
            // 批量生成模板选择变化事件
            document.getElementById('batch-template-select').addEventListener('change', function() {
                const templateId = this.value;
                showTemplatePreview(templateId, 'batch-template-preview', 'batch-template-image');
            });
        }

        // 显示模板预览
        function showTemplatePreview(templateId, previewDivId, imageId) {
            // 检查是否已登录
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                // 重置下拉框
                const selectElement = previewDivId === 'single-template-preview'
                    ? document.getElementById('template-select')
                    : document.getElementById('batch-template-select');
                selectElement.value = '';
                return;
            }
            
            const template = templates.find(t => t.id == templateId);
            const previewDiv = document.getElementById(previewDivId);
            const image = document.getElementById(imageId);
            
            if (template && template.imagePath) {
                // 直接使用相对路径
                image.src = template.imagePath;
                // 添加点击事件，使图片可以被打开查看
                image.style.cursor = 'pointer';
                image.onclick = function() {
                    openModal(template.imagePath, template.templateName, {
                        textX: template.textX,
                        textY: template.textY,
                        textWidth: template.textWidth,
                        textHeight: template.textHeight,
                        fontSize: template.fontSize
                    });
                };
                previewDiv.style.display = 'block';
                
                // 如果模板有坐标信息，在预览图片上绘制红色框
                if (template.textX || template.textY || template.textWidth || template.textHeight) {
                    image.onload = function() {
                        drawRedBoxOnPreview(image, template);
                    };
                    // 如果图片已缓存
                    if (image.complete) {
                        drawRedBoxOnPreview(image, template);
                    }
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }
        
        // 在预览图片上绘制红色框
         function drawRedBoxOnPreview(img, template) {
             // 查找或创建覆盖层canvas
             let overlayCanvas = document.getElementById(img.id + '-overlay');
             if (overlayCanvas) {
                 overlayCanvas.remove();
             }
             
             overlayCanvas = document.createElement('canvas');
             overlayCanvas.id = img.id + '-overlay';
             overlayCanvas.style.position = 'absolute';
             overlayCanvas.style.cursor = 'pointer';
             overlayCanvas.style.pointerEvents = 'none';
             overlayCanvas.style.zIndex = '10';
             
             // 将canvas插入到图片后面
             img.parentNode.insertBefore(overlayCanvas, img.nextSibling);
             
             // 等待图片加载完成
             setTimeout(() => {
                 const imageRect = img.getBoundingClientRect();
                 
                 overlayCanvas.width = imageRect.width;
                 overlayCanvas.height = imageRect.height;
                 overlayCanvas.style.left = '0';
                 overlayCanvas.style.top = '0';
                 
                 const overlayCtx = overlayCanvas.getContext('2d');
                 
                 // 计算缩放比例（显示宽高 / 自然宽高）
                 const scaleX = img.naturalWidth / imageRect.width;
                 const scaleY = img.naturalHeight / imageRect.height;
                 
                 // template中的坐标是相对坐标（0-1之间的比例），需要转换为自然宽高的绝对坐标
                 const x1 = (template.textX || 0) * img.naturalWidth;
                 const y1 = (template.textY || 0) * img.naturalHeight;
                 const width = (template.textWidth || 0) * img.naturalWidth;
                 const height = (template.textHeight || 0) * img.naturalHeight;
                 
                 // 绘制红色框（转换为显示坐标）
                 overlayCtx.strokeStyle = '#e63946';
                 overlayCtx.lineWidth = 3;
                 overlayCtx.fillStyle = 'rgba(230, 57, 70, 0.1)';
                 overlayCtx.fillRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
                 overlayCtx.strokeRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
                 
                 // 不在预览中显示文字标签
             }, 100);
         }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.remove('hidden');
            
            if (tab === 'account') {
                loadUserStats();
                loadUsageRecords();
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        async function generateSingle() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }

            const text = document.getElementById('single-text').value;
            const templateId = document.getElementById('template-select').value;
            
            if (!text.trim()) {
                showMessage('请输入文字', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> 生成中...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/photo/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ text, templateId })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    currentImages = [result.data];
                    const previewSection = document.getElementById('single-preview-section');
                    const previewDiv = document.getElementById('single-preview');
                    
                    previewDiv.innerHTML = `
                        <div class="preview-card" onclick="openModal('${result.data}', '${text.replace(/'/g, "\\'")}')">
                            <img src="${result.data}" alt="生成的图片" class="preview-image">
                            <div class="preview-text">${text}</div>
                        </div>
                    `;
                    previewSection.style.display = 'block';
                    showMessage('生成成功', 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('生成失败', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function exportSingleImage() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }
            
            if (currentImages.length === 0) {
                showMessage('没有可导出的图片', 'error');
                return;
            }

            fetch('/api/photo/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ imagePaths: currentImages })
            }).then(response => response.blob())
              .then(blob => {
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'photo.zip';
                  a.click();
                  window.URL.revokeObjectURL(url);
                  showMessage('导出成功', 'success');
              })
              .catch(() => showMessage('导出失败', 'error'));
        }

        async function generateBatch() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }

            const text = document.getElementById('batch-text').value;
            const templateId = document.getElementById('batch-template-select').value;
            
            if (!text.trim()) {
                showMessage('请输入文字', 'error');
                return;
            }

            const textList = text.split('\n').filter(t => t.trim());
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> 生成中...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/photo/batch-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ textList, templateId })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    currentImages = result.data;
                    const previewSection = document.getElementById('batch-preview-section');
                    const previewDiv = document.getElementById('batch-preview');
                    
                    previewDiv.innerHTML = result.data.map((img, index) => `
                        <div class="preview-card" onclick="openModal('${img}', '${textList[index].replace(/'/g, "\\'")}')">
                            <img src="${img}" alt="生成的图片" class="preview-image">
                            <div class="preview-text">${textList[index]}</div>
                        </div>
                    `).join('');
                    previewSection.style.display = 'block';
                    showMessage('批量生成成功', 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('批量生成失败', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function exportImages() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }
            
            if (currentImages.length === 0) {
                showMessage('没有可导出的图片', 'error');
                return;
            }

            fetch('/api/photo/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ imagePaths: currentImages })
            }).then(response => response.blob())
              .then(blob => {
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'photos.zip';
                  a.click();
                  window.URL.revokeObjectURL(url);
                  showMessage('导出成功', 'success');
              })
              .catch(() => showMessage('导出失败', 'error'));
        }

        async function handleExcelUpload() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }

            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            const templateId = document.getElementById('batch-template-select').value;
            
            if (!file) {
                showMessage('请选择文件', 'error');
                return;
            }

            if (!templateId) {
                showMessage('请选择模板', 'error');
                return;
            }

            showMessage('正在处理Excel文件...', 'success');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('templateId', templateId);

            try {
                const response = await fetch('/api/photo/upload-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    showMessage('上传失败：' + response.status, 'error');
                    fileInput.value = '';
                    return;
                }
                
                const result = await response.json();
                
                if (result.code === 200) {
                    currentImages = result.data;
                    const previewSection = document.getElementById('batch-preview-section');
                    const previewDiv = document.getElementById('batch-preview');
                    
                    previewDiv.innerHTML = result.data.map(img => `
                        <div class="preview-card" onclick="openModal('${img}', '')">
                            <img src="${img}" alt="生成的图片" class="preview-image">
                        </div>
                    `).join('');
                    previewSection.style.display = 'block';
                    const count = result.data.length;
                    showMessage(`Excel处理成功，共生成 ${count} 张图片`, 'success');
                } else {
                    showMessage(result.message || 'Excel处理失败', 'error');
                }
            } catch (error) {
                console.error('Excel处理错误:', error);
                showMessage('Excel处理失败：' + error.message, 'error');
            }
            
            // 重置input，允许再次选择同一文件
            fileInput.value = '';
        }

        function exportExcelImages() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }
            
            if (currentImages.length === 0) {
                showMessage('没有可导出的图片', 'error');
                return;
            }

            fetch('/api/photo/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ imagePaths: currentImages })
            }).then(response => response.blob())
              .then(blob => {
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'photos.zip';
                  a.click();
                  window.URL.revokeObjectURL(url);
                  showMessage('导出成功', 'success');
              })
              .catch(() => showMessage('导出失败', 'error'));
        }

        async function logout() {
            // 显示登出模态框
            const logoutModal = document.getElementById('logoutModal');
            logoutModal.classList.add('show');
            
            // 禁用所有按钮
            disableAllButtons(true);
            
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // 延迟一下以显示动画效果
            setTimeout(() => {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                localStorage.removeItem('role');
                isLoggedIn = false;
                token = null;
                userRole = null;
                
                // 隐藏模态框
                logoutModal.classList.remove('show');
                
                // 关闭账户模态框
                const accountModal = document.getElementById('accountModal');
                if (accountModal) {
                    accountModal.classList.remove('show');
                }
                
                // 关闭图片查看模态框
                const imageModal = document.getElementById('imageModal');
                if (imageModal) {
                    imageModal.style.display = 'none';
                }
                
                // 清空模板下拉框
                document.getElementById('template-select').innerHTML = '<option value="">请选择模板</option>';
                document.getElementById('batch-template-select').innerHTML = '<option value="">请选择模板</option>';
                templates = [];
                
                // 隐藏模板预览
                document.getElementById('single-template-preview').style.display = 'none';
                document.getElementById('batch-template-preview').style.display = 'none';
                
                // 清空预览结果
                document.getElementById('single-preview').innerHTML = '';
                document.getElementById('batch-preview').innerHTML = '';
                document.getElementById('single-preview-section').style.display = 'none';
                document.getElementById('batch-preview-section').style.display = 'none';
                
                // 清空预览图片src
                document.getElementById('single-template-image').src = '';
                document.getElementById('batch-template-image').src = '';
                
                // 清空所有表单输入
                document.getElementById('single-text').value = '';
                document.getElementById('batch-text').value = '';
                document.getElementById('template-name').value = '';
                document.getElementById('template-file').value = '';
                document.getElementById('excel-file').value = '';
                
                // 清空模板预览表单
                document.getElementById('template-preview-img').src = '';
                document.getElementById('template-preview-section').style.display = 'none';
                document.getElementById('text-area-settings').style.display = 'none';
                document.getElementById('text-x').value = '0';
                document.getElementById('text-y').value = '0';
                document.getElementById('text-width').value = '0';
                document.getElementById('text-height').value = '0';
                document.getElementById('font-size').value = '37';
                document.getElementById('font-color').value = '#000000';
                document.getElementById('coord-display').textContent = '请在图片上点击并拖动来标注文字区域';
                
                // 清空所有表格数据
                document.getElementById('modal-usage-records').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载中...</td></tr>';
                document.getElementById('my-templates-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">加载中...</td></tr>';
                document.getElementById('admin-users-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载中...</td></tr>';
                document.getElementById('admin-records-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载中...</td></tr>';
                
                // 重置分页信息
                document.getElementById('modal-page-info').textContent = '第 1 页';
                document.getElementById('my-templates-page-info').textContent = '第 1 页';
                document.getElementById('admin-users-page-info').textContent = '第 1 页';
                document.getElementById('admin-records-page-info').textContent = '第 1 页';
                
                // 重置统计数据
                document.getElementById('modal-today-count').textContent = '0';
                document.getElementById('modal-month-count').textContent = '0';
                document.getElementById('modal-total-count').textContent = '0';
                document.getElementById('admin-user-count').textContent = '0';
                document.getElementById('admin-total-generate').textContent = '0';
                document.getElementById('admin-today-generate').textContent = '0';
                
                // 重置标签页状态
                currentPage = 1;
                totalPages = 1;
                modalCurrentPage = 1;
                modalTotalPages = 1;
                adminCurrentPage = 1;
                adminTotalPages = 1;
                myTemplatesCurrentPage = 1;
                myTemplatesTotalPages = 1;
                currentImages = [];
                isDrawing = false;
                
                // 重新启用按钮
                disableAllButtons(false);
                
                // 更新UI
                initPage();
                
                // 显示成功消息
                showMessage('已成功退出登录', 'success');
            }, 1500);
        }

        function disableAllButtons(disabled) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = disabled;
            });
        }

        async function loadUserStats() {
            try {
                const response = await fetch('/api/photo/user-stats', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const stats = result.data;
                    document.getElementById('modal-today-count').textContent = stats.todayCount || 0;
                    document.getElementById('modal-month-count').textContent = stats.monthCount || 0;
                    document.getElementById('modal-total-count').textContent = stats.totalCount || 0;
                }
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }

        async function loadUsageRecords(page = 1) {
            try {
                const response = await fetch(`/api/photo/user-records?page=${page}&size=10`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const records = result.data.records || [];
                    modalCurrentPage = result.data.current || page;
                    modalTotalPages = result.data.pages || 1;
                    
                    const tbody = document.getElementById('modal-usage-records');
                    
                    if (records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">暂无使用记录</td></tr>';
                    } else {
                        tbody.innerHTML = records.map(record => {
                            let downloadButtons = '';
                            if (record.imagePaths) {
                                try {
                                    // 尝试解析为JSON
                                    const paths = JSON.parse(record.imagePaths);
                                    if (Array.isArray(paths) && paths.length > 0) {
                                        downloadButtons = paths.map((path, index) => `
                                            <a href="${path}" download="image_${index + 1}.png" class="btn btn-success" style="padding: 6px 12px; font-size: 12px; margin: 2px;">
                                                <i class="fas fa-download"></i>图片${index + 1}
                                            </a>
                                        `).join('');
                                    } else if (typeof paths === 'string') {
                                        downloadButtons = `
                                            <a href="${paths}" download="image.png" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                                <i class="fas fa-download"></i>下载
                                            </a>
                                        `;
                                    }
                                } catch (e) {
                                    // JSON解析失败，说明是普通字符串
                                    console.log('imagePaths是普通字符串:', record.imagePaths);
                                    downloadButtons = `
                                        <a href="${record.imagePaths}" download="image.png" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                            <i class="fas fa-download"></i>下载
                                        </a>
                                    `;
                                }
                            }
                            
                            return `
                                <tr>
                                    <td>${formatDate(record.createTime)}</td>
                                    <td>${record.templateName || '-'}</td>
                                    <td>${record.count}</td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${record.textContent || ''}">${record.textContent || '-'}</td>
                                    <td>${downloadButtons || '-'}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                    
                    document.getElementById('modal-page-info').textContent = `第 ${modalCurrentPage} 页 / 共 ${modalTotalPages} 页`;
                }
            } catch (error) {
                console.error('加载使用明细失败:', error);
                document.getElementById('modal-usage-records').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载失败</td></tr>';
            }
        }

        function previousModalPage() {
            if (modalCurrentPage > 1) {
                loadUsageRecords(modalCurrentPage - 1);
            }
        }

        function nextModalPage() {
            if (modalCurrentPage < modalTotalPages) {
                loadUsageRecords(modalCurrentPage + 1);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 切换账户标签页
        function switchAccountTab(tab) {
            const userTabContent = document.getElementById('user-tab-content');
            const adminTabContent = document.getElementById('admin-tab-content');
            
            // 隐藏所有标签页内容
            if (userTabContent) userTabContent.style.display = 'none';
            if (adminTabContent) adminTabContent.style.display = 'none';
            
            // 移除所有标签页的active类
            document.querySelectorAll('#account-tabs .tab').forEach(t => t.classList.remove('active'));
            
            // 显示选中的标签页
            if (tab === 'user') {
                if (userTabContent) userTabContent.style.display = 'block';
                const tabs = document.querySelectorAll('#account-tabs .tab');
                if (tabs.length > 0) tabs[0].classList.add('active');
            } else if (tab === 'admin') {
                // 检查权限
                if (userRole != 1 && userRole !== '1') {
                    showMessage('无权限访问', 'error');
                    return;
                }
                if (adminTabContent) adminTabContent.style.display = 'block';
                const adminTab = document.getElementById('admin-tab');
                if (adminTab) adminTab.classList.add('active');
                // 加载管理员数据
                loadAdminStatistics();
            }
        }
        
        // 切换管理员标签页
        function switchAdminTab(tab) {
            // 隐藏所有管理员标签页
            document.getElementById('admin-statistics').style.display = 'none';
            document.getElementById('admin-users').style.display = 'none';
            document.getElementById('admin-records').style.display = 'none';
            
            // 移除所有标签页的active类
            document.querySelectorAll('#admin-tab-content .tabs .tab').forEach(t => t.classList.remove('active'));
            
            // 显示选中的标签页
            if (tab === 'statistics') {
                document.getElementById('admin-statistics').style.display = 'block';
                document.querySelectorAll('#admin-tab-content .tabs .tab')[0].classList.add('active');
                loadAdminStatistics();
            } else if (tab === 'users') {
                document.getElementById('admin-users').style.display = 'block';
                document.querySelectorAll('#admin-tab-content .tabs .tab')[1].classList.add('active');
                loadAdminUsers(1);
            } else if (tab === 'records') {
                document.getElementById('admin-records').style.display = 'block';
                document.querySelectorAll('#admin-tab-content .tabs .tab')[2].classList.add('active');
                loadAdminRecords(1);
            }
        }
        
        // 加载管理员统计信息
        async function loadAdminStatistics() {
            try {
                const response = await fetch('/api/admin/statistics', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const stats = result.data;
                    document.getElementById('admin-user-count').textContent = stats.userCount || 0;
                    document.getElementById('admin-total-generate').textContent = stats.totalCount || 0;
                    document.getElementById('admin-today-generate').textContent = stats.todayCount || 0;
                }
            } catch (error) {
                console.error('加载管理员统计信息失败:', error);
            }
        }
        
        // 加载管理员用户列表
        async function loadAdminUsers(page = 1) {
            try {
                const response = await fetch(`/api/admin/users?page=${page}&size=10`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const users = result.data.records || [];
                    adminCurrentPage = result.data.current || page;
                    adminTotalPages = result.data.pages || 1;
                    
                    const tbody = document.getElementById('admin-users-tbody');
                    
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">暂无用户</td></tr>';
                    } else {
                        tbody.innerHTML = users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email || '-'}</td>
                                <td>${user.phone || '-'}</td>
                                <td>${user.role === 1 ? '管理员' : '普通用户'}</td>
                                <td>${formatDate(user.createTime)}</td>
                            </tr>
                        `).join('');
                    }
                    
                    document.getElementById('admin-users-page-info').textContent = `第 ${adminCurrentPage} 页 / 共 ${adminTotalPages} 页`;
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
                document.getElementById('admin-users-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载失败</td></tr>';
            }
        }
        
        // 加载管理员使用记录
        async function loadAdminRecords(page = 1) {
            try {
                const response = await fetch(`/api/admin/usage-records?page=${page}&size=10`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const records = result.data.records || [];
                    adminCurrentPage = result.data.current || page;
                    adminTotalPages = result.data.pages || 1;
                    
                    const tbody = document.getElementById('admin-records-tbody');
                    
                    if (records.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">暂无记录</td></tr>';
                    } else {
                        tbody.innerHTML = records.map(record => `
                            <tr>
                                <td>${record.username}</td>
                                <td>${formatDate(record.createTime)}</td>
                                <td>${record.templateName || '-'}</td>
                                <td>${record.count}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${record.textContent || ''}">${record.textContent || '-'}</td>
                            </tr>
                        `).join('');
                    }
                    
                    document.getElementById('admin-records-page-info').textContent = `第 ${adminCurrentPage} 页 / 共 ${adminTotalPages} 页`;
                }
            } catch (error) {
                console.error('加载使用记录失败:', error);
                document.getElementById('admin-records-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">加载失败</td></tr>';
            }
        }
        
        // 管理员用户列表分页
        function previousAdminUsersPage() {
            if (adminCurrentPage > 1) {
                loadAdminUsers(adminCurrentPage - 1);
            }
        }
        
        function nextAdminUsersPage() {
            if (adminCurrentPage < adminTotalPages) {
                loadAdminUsers(adminCurrentPage + 1);
            }
        }
        
        // 管理员使用记录分页
        function previousAdminRecordsPage() {
            if (adminCurrentPage > 1) {
                loadAdminRecords(adminCurrentPage - 1);
            }
        }
        
        function nextAdminRecordsPage() {
            if (adminCurrentPage < adminTotalPages) {
                loadAdminRecords(adminCurrentPage + 1);
            }
        }

        function goToAccount() {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                return;
            }
            
            // 显示账户模态框
            const accountModal = document.getElementById('accountModal');
            accountModal.classList.add('show');
            
            // 重新获取role信息
            userRole = localStorage.getItem('role');
            console.log('goToAccount - 读取的role:', userRole);
            const adminTab = document.getElementById('admin-tab');
            
            // 如果是管理员，显示管理员标签页按钮
            if (adminTab) {
                if (userRole == 1 || userRole === '1') {
                    console.log('goToAccount - 显示管理员按钮');
                    adminTab.style.display = 'inline-block';
                } else {
                    console.log('goToAccount - 隐藏管理员按钮，role值:', userRole);
                    adminTab.style.display = 'none';
                }
            } else {
                console.log('goToAccount - adminTab元素不存在');
            }
            
            // 默认显示个人信息标签页
            switchAccountTab('user');
            
            // 加载个人数据
            loadUserStats();
            loadUsageRecords(1);
        }

        function closeAccountModal() {
            const accountModal = document.getElementById('accountModal');
            accountModal.classList.remove('show');
        }

        // 点击模态框背景关闭
        document.getElementById('accountModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAccountModal();
            }
        });

        // 图片查看模态框功能
         function openModal(imageSrc, caption, templateData) {
             const modal = document.getElementById('imageModal');
             const modalImg = document.getElementById('modalImage');
             const modalCaption = document.getElementById('modalCaption');
             
             modal.style.display = 'block';
             modalImg.src = imageSrc;
             modalCaption.textContent = caption || '';
             document.body.style.overflow = 'hidden';
             
             // 如果有模板数据，绘制红色框（模板预览）
             if (templateData && (templateData.textX || templateData.textY || templateData.textWidth || templateData.textHeight)) {
                 modalImg.onload = function() {
                     drawRedBoxOnModal(modalImg, templateData);
                 };
                 // 如果图片已缓存
                 if (modalImg.complete) {
                     drawRedBoxOnModal(modalImg, templateData);
                 }
             } else {
                 // 如果没有模板数据，初始化模态框中的框选功能
                 modalImg.onload = function() {
                     initModalCanvasForDrawing(modalImg);
                 };
                 // 如果图片已缓存
                 if (modalImg.complete) {
                     initModalCanvasForDrawing(modalImg);
                 }
             }
         }

        // 在模态框中绘制红色框
        function drawRedBoxOnModal(img, templateData) {
            // 创建覆盖层canvas
            let overlayCanvas = document.getElementById('modalOverlayCanvas');
            if (overlayCanvas) {
                overlayCanvas.remove();
            }
            
            overlayCanvas = document.createElement('canvas');
            overlayCanvas.id = 'modalOverlayCanvas';
            overlayCanvas.style.position = 'absolute';
            overlayCanvas.style.cursor = 'pointer';
            overlayCanvas.style.zIndex = '10001';
            overlayCanvas.style.pointerEvents = 'none';
            document.getElementById('imageModal').appendChild(overlayCanvas);
            
            // 等待图片加载完成
            setTimeout(() => {
                const imageRect = img.getBoundingClientRect();
                const scaleX = img.naturalWidth / imageRect.width;
                const scaleY = img.naturalHeight / imageRect.height;
                
                overlayCanvas.width = imageRect.width;
                overlayCanvas.height = imageRect.height;
                overlayCanvas.style.left = imageRect.left + 'px';
                overlayCanvas.style.top = imageRect.top + 'px';
                
                const overlayCtx = overlayCanvas.getContext('2d');
                const x = templateData.textX || 0;
                const y = templateData.textY || 0;
                const width = templateData.textWidth || 0;
                const height = templateData.textHeight || 0;
                
                // 绘制红色框
                overlayCtx.strokeStyle = '#e63946';
                overlayCtx.lineWidth = 3;
                overlayCtx.fillStyle = 'rgba(230, 57, 70, 0.1)';
                overlayCtx.fillRect(x / scaleX, y / scaleY, width / scaleX, height / scaleY);
                overlayCtx.strokeRect(x / scaleX, y / scaleY, width / scaleX, height / scaleY);
                
                // 在红色框内绘制提示文字
                if (width > 0 && height > 0) {
                    const centerX = (x + width / 2) / scaleX;
                    const centerY = (y + height / 2) / scaleY;
                    
                    // 获取表单中的字体大小
                    const fontSize = parseInt(document.getElementById('font-size').value) || 37;
                    
                    overlayCtx.fillStyle = '#e63946';
                    overlayCtx.font = `bold ${fontSize}px Arial`;
                    overlayCtx.textAlign = 'center';
                    overlayCtx.textBaseline = 'middle';
                    overlayCtx.fillText('文字区域', centerX, centerY);
                }
            }, 100);
        }

        // 在模态框中初始化框选功能
        let modalIsDrawing = false;
        let modalStartX, modalStartY;
        let modalOverlayCanvas = null;
        let modalOverlayCtx = null;

        function initModalCanvasForDrawing(img) {
            // 创建覆盖层canvas用于框选
            let overlayCanvas = document.getElementById('modalOverlayCanvas');
            if (overlayCanvas) {
                overlayCanvas.remove();
            }
            
            overlayCanvas = document.createElement('canvas');
            overlayCanvas.id = 'modalOverlayCanvas';
            overlayCanvas.style.position = 'absolute';
            overlayCanvas.style.cursor = 'crosshair';
            overlayCanvas.style.zIndex = '10001';
            overlayCanvas.style.pointerEvents = 'auto';
            document.getElementById('imageModal').appendChild(overlayCanvas);
            
            // 等待图片加载完成
            setTimeout(() => {
                const imageRect = img.getBoundingClientRect();
                overlayCanvas.width = imageRect.width;
                overlayCanvas.height = imageRect.height;
                overlayCanvas.style.left = imageRect.left + 'px';
                overlayCanvas.style.top = imageRect.top + 'px';
                
                modalOverlayCanvas = overlayCanvas;
                modalOverlayCtx = overlayCanvas.getContext('2d');
                
                // 绑定鼠标事件
                overlayCanvas.addEventListener('mousedown', (e) => modalStartDrawing(e, img));
                overlayCanvas.addEventListener('mousemove', (e) => modalDrawRectangle(e, img));
                overlayCanvas.addEventListener('mouseup', (e) => modalEndDrawing(e, img));
                overlayCanvas.addEventListener('mouseleave', (e) => modalEndDrawing(e, img));
            }, 100);
        }

        function modalStartDrawing(event, img) {
            modalIsDrawing = true;
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const scaleX = img.naturalWidth / img.width;
            const scaleY = img.naturalHeight / img.height;
            
            modalStartX = Math.round(x * scaleX);
            modalStartY = Math.round(y * scaleY);
        }

        function modalDrawRectangle(event, img) {
            if (!modalIsDrawing || !modalOverlayCtx) return;
            
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const scaleX = img.naturalWidth / img.width;
            const scaleY = img.naturalHeight / img.height;
            
            const currentX = Math.round(x * scaleX);
            const currentY = Math.round(y * scaleY);
            
            // 清空canvas
            modalOverlayCtx.clearRect(0, 0, modalOverlayCanvas.width, modalOverlayCanvas.height);
            
            // 计算矩形
            const x1 = Math.min(modalStartX, currentX);
            const y1 = Math.min(modalStartY, currentY);
            const x2 = Math.max(modalStartX, currentX);
            const y2 = Math.max(modalStartY, currentY);
            
            const width = x2 - x1;
            const height = y2 - y1;
            
            // 绘制红色框
            modalOverlayCtx.strokeStyle = '#e63946';
            modalOverlayCtx.lineWidth = 3;
            modalOverlayCtx.fillStyle = 'rgba(230, 57, 70, 0.1)';
            modalOverlayCtx.fillRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
            modalOverlayCtx.strokeRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
            
            // 在红色框左上角绘制提示文字
            if (width > 0 && height > 0) {
                const textX = x1 / scaleX + 10;
                const textY = y1 / scaleY + 20;
                
                // 获取表单中的字体大小
                const fontSize = parseInt(document.getElementById('font-size').value) || 37;
                
                modalOverlayCtx.fillStyle = '#e63946';
                modalOverlayCtx.font = `bold ${fontSize}px Arial`;
                modalOverlayCtx.textAlign = 'left';
                modalOverlayCtx.textBaseline = 'top';
                modalOverlayCtx.fillText('文字区域', textX, textY);
            }
        }

        function modalEndDrawing(event, img) {
            if (!modalIsDrawing) return;
            
            modalIsDrawing = false;
            
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const scaleX = img.naturalWidth / img.width;
            const scaleY = img.naturalHeight / img.height;
            
            const endX = Math.round(x * scaleX);
            const endY = Math.round(y * scaleY);
            
            // 计算矩形区域
            const x1 = Math.min(modalStartX, endX);
            const y1 = Math.min(modalStartY, endY);
            const x2 = Math.max(modalStartX, endX);
            const y2 = Math.max(modalStartY, endY);
            
            const width = x2 - x1;
            const height = y2 - y1;
            
            if (width > 0 && height > 0) {
                // 重新绘制最终的红色框和提示文字
                modalOverlayCtx.clearRect(0, 0, modalOverlayCanvas.width, modalOverlayCanvas.height);
                modalOverlayCtx.strokeStyle = '#e63946';
                modalOverlayCtx.lineWidth = 3;
                modalOverlayCtx.fillStyle = 'rgba(230, 57, 70, 0.1)';
                modalOverlayCtx.fillRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
                modalOverlayCtx.strokeRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
                
                // 绘制提示文字在左上角
                const textX = x1 / scaleX + 10;
                const textY = y1 / scaleY + 20;
                
                // 获取表单中的字体大小
                const fontSize = parseInt(document.getElementById('font-size').value) || 37;
                
                modalOverlayCtx.fillStyle = '#e63946';
                modalOverlayCtx.font = `bold ${fontSize}px Arial`;
                modalOverlayCtx.textAlign = 'left';
                modalOverlayCtx.textBaseline = 'top';
                modalOverlayCtx.fillText('文字区域', textX, textY);
            }
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // 清除覆盖层canvas
            const overlayCanvas = document.getElementById('modalOverlayCanvas');
            if (overlayCanvas) {
                overlayCanvas.remove();
            }
            
            // 重置框选状态
            modalIsDrawing = false;
            modalOverlayCanvas = null;
            modalOverlayCtx = null;
        }

        // 点击模态框背景关闭
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        loadTemplates();

        // Excel上传区域点击事件
        document.getElementById('excel-upload-area').addEventListener('click', function(e) {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                e.preventDefault();
                e.stopPropagation();
            }
        });

        // Excel文件input点击事件
        document.getElementById('excel-file').addEventListener('click', function(e) {
            if (!isLoggedIn) {
                e.preventDefault();
                e.stopPropagation();
                showMessage('请先登录', 'error');
            }
        });

        // 模板上传区域点击事件
        document.getElementById('template-upload-area').addEventListener('click', function(e) {
            if (!isLoggedIn) {
                showMessage('请先登录', 'error');
                e.preventDefault();
                e.stopPropagation();
            }
        });

        // 模板文件input点击事件
        document.getElementById('template-file').addEventListener('click', function(e) {
            if (!isLoggedIn) {
                e.preventDefault();
                e.stopPropagation();
                showMessage('请先登录', 'error');
            }
        });


        // 更新字体大小和颜色预览
        function updateFontSizePreview() {
            const fontSize = parseInt(document.getElementById('font-size').value) || 37;
            const fontColor = document.getElementById('font-color').value || '#000000';
            const previewText = document.getElementById('preview-text');
            previewText.style.fontSize = fontSize + 'px';
            previewText.style.color = fontColor;
        }

        // 处理模板图片上传
          function handleTemplateImageUpload() {
              if (!isLoggedIn) {
                  showMessage('请先登录', 'error');
                  return;
              }

              const fileInput = document.getElementById('template-file');
              const file = fileInput.files[0];
              
              if (!file) {
                  showMessage('请选择文件', 'error');
                  return;
              }

              // 读取图片并显示预览
              const reader = new FileReader();
              reader.onload = function(e) {
                  const img = document.getElementById('template-preview-img');
                  img.src = e.target.result;
                  
                  // 显示预览区域和设置区域
                  document.getElementById('template-preview-section').style.display = 'block';
                  document.getElementById('text-area-settings').style.display = 'block';
                  
                  // 图片加载完成后初始化Canvas
                  img.onload = function() {
                      initTemplateCanvas(img);
                  };
                  
                  // 如果图片已缓存，立即初始化
                  if (img.complete) {
                      initTemplateCanvas(img);
                  }
              };
              reader.readAsDataURL(file);
          }

        // 处理图片点击事件，标注文字区域
         let isDrawing = false;
         let startX, startY;
         let templatePreviewCanvas = null;
         let templatePreviewCtx = null;

         function handleImageClick(event, img) {
             // 这个函数已被拖动绘制功能替代
         }

         // 初始化Canvas用于绘制红色框
         function initTemplateCanvas(img) {
             const canvas = document.getElementById('template-preview-canvas');
             if (!canvas) return;
             
             // 获取图片容器的位置信息
             const imgContainer = img.parentNode;
             const imgRect = img.getBoundingClientRect();
             const containerRect = imgContainer.getBoundingClientRect();
             
             canvas.width = img.width;
             canvas.height = img.height;
             canvas.style.display = 'block';
             canvas.style.pointerEvents = 'auto';
             canvas.style.cursor = 'crosshair';
             canvas.style.left = (imgRect.left - containerRect.left) + 'px';
             canvas.style.top = (imgRect.top - containerRect.top) + 'px';
             
             templatePreviewCanvas = canvas;
             templatePreviewCtx = canvas.getContext('2d');
             
             // 绑定鼠标事件
             canvas.addEventListener('mousedown', (e) => startDrawing(e, img));
             canvas.addEventListener('mousemove', (e) => drawRectangle(e, img));
             canvas.addEventListener('mouseup', (e) => endDrawing(e, img));
             canvas.addEventListener('mouseleave', (e) => endDrawing(e, img));
             
             // 初始化字体大小预览
             updateFontSizePreview();
         }

         function startDrawing(event, img) {
             isDrawing = true;
             const rect = event.target.getBoundingClientRect();
             const x = event.clientX - rect.left;
             const y = event.clientY - rect.top;
             
             const scaleX = img.naturalWidth / img.width;
             const scaleY = img.naturalHeight / img.height;
             
             startX = Math.round(x * scaleX);
             startY = Math.round(y * scaleY);
         }

         function drawRectangle(event, img) {
             if (!isDrawing || !templatePreviewCtx) return;
             
             const rect = event.target.getBoundingClientRect();
             const x = event.clientX - rect.left;
             const y = event.clientY - rect.top;
             
             const scaleX = img.naturalWidth / img.width;
             const scaleY = img.naturalHeight / img.height;
             
             const currentX = Math.round(x * scaleX);
             const currentY = Math.round(y * scaleY);
             
             // 清空canvas
             templatePreviewCtx.clearRect(0, 0, templatePreviewCanvas.width, templatePreviewCanvas.height);
             
             // 计算矩形
             const x1 = Math.min(startX, currentX);
             const y1 = Math.min(startY, currentY);
             const x2 = Math.max(startX, currentX);
             const y2 = Math.max(startY, currentY);
             
             const width = x2 - x1;
             const height = y2 - y1;
             
             // 绘制红色框
             templatePreviewCtx.strokeStyle = '#e63946';
             templatePreviewCtx.lineWidth = 3;
             templatePreviewCtx.fillStyle = 'rgba(230, 57, 70, 0.1)';
             templatePreviewCtx.fillRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
             templatePreviewCtx.strokeRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
             
             // 在红色框左上角绘制提示文字
             if (width > 0 && height > 0) {
                 const textX = x1 / scaleX + 10;
                 const textY = y1 / scaleY + 20;
                 
                 const fontSize = parseInt(document.getElementById('font-size').value) || 37;
                 const displayFontSize = Math.max(12, Math.round(fontSize / scaleX));
                 
                 templatePreviewCtx.fillStyle = '#e63946';
                 templatePreviewCtx.font = `bold ${displayFontSize}px Arial`;
                 templatePreviewCtx.textAlign = 'left';
                 templatePreviewCtx.textBaseline = 'top';
                 templatePreviewCtx.fillText('文字区域', textX, textY);
             }
             
             // 显示坐标信息（相对坐标）
             const displayImgWidth = img.naturalWidth;
             const displayImgHeight = img.naturalHeight;
             const relX = (x1 / displayImgWidth).toFixed(4);
             const relY = (y1 / displayImgHeight).toFixed(4);
             const relWidth = (width / displayImgWidth).toFixed(4);
             const relHeight = (height / displayImgHeight).toFixed(4);
             
             document.getElementById('coord-display').innerHTML = `
                 <strong>正在标注（相对位置）：</strong><br>
                 X: ${relX}, Y: ${relY}<br>
                 宽度: ${relWidth}, 高度: ${relHeight}
             `;
         }

         function endDrawing(event, img) {
             if (!isDrawing) return;
             
             isDrawing = false;
             
             const rect = event.target.getBoundingClientRect();
             const x = event.clientX - rect.left;
             const y = event.clientY - rect.top;
             
             const scaleX = img.naturalWidth / img.width;
             const scaleY = img.naturalHeight / img.height;
             
             const endX = Math.round(x * scaleX);
             const endY = Math.round(y * scaleY);
             
             // 计算矩形区域
             const x1 = Math.min(startX, endX);
             const y1 = Math.min(startY, endY);
             const x2 = Math.max(startX, endX);
             const y2 = Math.max(startY, endY);
             
             const width = x2 - x1;
             const height = y2 - y1;
             
             if (width > 0 && height > 0) {
                 // 更新表单字段（保存相对位置：相对于图片的百分比）
                 const imgWidth = img.naturalWidth;
                 const imgHeight = img.naturalHeight;
                 
                 const relativeX = Math.round((x1 / imgWidth) * 10000) / 10000;
                 const relativeY = Math.round((y1 / imgHeight) * 10000) / 10000;
                 const relativeWidth = Math.round((width / imgWidth) * 10000) / 10000;
                 const relativeHeight = Math.round((height / imgHeight) * 10000) / 10000;
                 
                 document.getElementById('text-x').value = relativeX;
                 document.getElementById('text-y').value = relativeY;
                 document.getElementById('text-width').value = relativeWidth;
                 document.getElementById('text-height').value = relativeHeight;
                 
                 // 重新绘制最终的红色框和提示文字
                 templatePreviewCtx.clearRect(0, 0, templatePreviewCanvas.width, templatePreviewCanvas.height);
                 templatePreviewCtx.strokeStyle = '#e63946';
                 templatePreviewCtx.lineWidth = 3;
                 templatePreviewCtx.fillStyle = 'rgba(230, 57, 70, 0.1)';
                 templatePreviewCtx.fillRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
                 templatePreviewCtx.strokeRect(x1 / scaleX, y1 / scaleY, width / scaleX, height / scaleY);
                 
                 // 绘制提示文字在左上角
                 const textX = x1 / scaleX + 10;
                 const textY = y1 / scaleY + 20;
                 
                 const fontSize = parseInt(document.getElementById('font-size').value) || 37;
                 const displayFontSize = Math.max(12, Math.round(fontSize / scaleX));
                 
                 templatePreviewCtx.fillStyle = '#e63946';
                 templatePreviewCtx.font = `bold ${displayFontSize}px Arial`;
                 templatePreviewCtx.textAlign = 'left';
                 templatePreviewCtx.textBaseline = 'top';
                 templatePreviewCtx.fillText('文字区域', textX, textY);
                 
                 // 显示坐标信息（相对坐标）
                 const endImgWidth = img.naturalWidth;
                 const endImgHeight = img.naturalHeight;
                 const endRelX = (x1 / endImgWidth).toFixed(4);
                 const endRelY = (y1 / endImgHeight).toFixed(4);
                 const endRelWidth = (width / endImgWidth).toFixed(4);
                 const endRelHeight = (height / endImgHeight).toFixed(4);
                 
                 document.getElementById('coord-display').innerHTML = `
                     <strong>文字区域已标注（相对位置）：</strong><br>
                     X: ${endRelX}, Y: ${endRelY}<br>
                     宽度: ${endRelWidth}, 高度: ${endRelHeight}
                 `;
             }
         }

        // 提交模板
         async function submitTemplate() {
             if (!isLoggedIn) {
                 showMessage('请先登录', 'error');
                 return;
             }

             const templateName = document.getElementById('template-name').value.trim();
             const templateFile = document.getElementById('template-file').files[0];
             const textX = parseFloat(document.getElementById('text-x').value) || 0;
             const textY = parseFloat(document.getElementById('text-y').value) || 0;
             const textWidth = parseFloat(document.getElementById('text-width').value) || 0;
             const textHeight = parseFloat(document.getElementById('text-height').value) || 0;
             const coverColor = document.getElementById('cover-color').value || '#ffffff';
             const fontSize = parseInt(document.getElementById('font-size').value) || 37;
             const fontColor = document.getElementById('font-color').value || '#000000';

            if (!templateName) {
                showMessage('请输入模板名称', 'error');
                return;
            }

            if (!templateFile) {
                showMessage('请上传模板图片', 'error');
                return;
            }

            if (textWidth <= 0 || textHeight <= 0) {
                showMessage('请标注文字区域', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> 保存中...';
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', templateFile);
                formData.append('templateName', templateName);
                formData.append('textX', textX);
                formData.append('textY', textY);
                formData.append('textWidth', textWidth);
                formData.append('textHeight', textHeight);
                formData.append('coverColor', coverColor);
                formData.append('fontSize', fontSize);
                formData.append('fontColor', fontColor);

                const response = await fetch('/api/photo/create-template', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.code === 200) {
                    showMessage('模板创建成功', 'success');
                    resetTemplateForm();
                    // 重新加载模板列表
                    loadTemplates();
                } else {
                    showMessage(result.message || '创建模板失败', 'error');
                }
            } catch (error) {
                console.error('创建模板错误:', error);
                showMessage('创建模板失败：' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // 重置模板表单
        function resetTemplateForm() {
            document.getElementById('template-name').value = '';
            document.getElementById('template-file').value = '';
            document.getElementById('template-preview-section').style.display = 'none';
            document.getElementById('text-area-settings').style.display = 'none';
            document.getElementById('text-x').value = '0';
            document.getElementById('text-y').value = '0';
            document.getElementById('text-width').value = '0';
            document.getElementById('text-height').value = '0';
            document.getElementById('font-size').value = '37';
            document.getElementById('font-color').value = '#000000';
            document.getElementById('coord-display').textContent = '请在图片上拖动鼠标来标注文字区域';
            isDrawing = false;
            
            // 清空模板预览图片
            const previewImg = document.getElementById('template-preview-img');
            if (previewImg) {
                previewImg.src = '';
            }
            
            // 清空Canvas
            const canvas = document.getElementById('template-preview-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                canvas.style.display = 'none';
            }
            
            // 重置字体预览
            updateFontSizePreview();
        }

        // 我的模板分页变量
        let myTemplatesCurrentPage = 1;
        let myTemplatesTotalPages = 1;

        // 加载我的模板列表
        async function loadMyTemplates(page = 1) {
            if (!isLoggedIn) {
                document.getElementById('my-templates-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">请先登录</td></tr>';
                return;
            }

            try {
                const response = await fetch(`/api/photo/my-templates?page=${page}&size=5`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    const templates = result.data.records || [];
                    myTemplatesCurrentPage = result.data.current || page;
                    myTemplatesTotalPages = result.data.pages || 1;
                    
                    const tbody = document.getElementById('my-templates-tbody');
                    
                    if (templates.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">暂无模板</td></tr>';
                    } else {
                        tbody.innerHTML = templates.map(template => {
                            const templateData = {textX: template.textX, textY: template.textY, textWidth: template.textWidth, textHeight: template.textHeight};
                            return `
                            <tr>
                                <td>${template.templateName}</td>
                                <td>${formatDate(template.createTime)}</td>
                                <td>${template.status === 1 ? '启用' : '禁用'}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="viewTemplateImage('${template.imagePath.replace(/'/g, "\\'")}', '${template.templateName.replace(/'/g, "\\'")}', ${JSON.stringify(templateData).replace(/"/g, '"')})" style="padding: 6px 12px; font-size: 12px; margin: 2px;">
                                        <i class="fas fa-eye"></i>查看
                                    </button>
                                    <button class="btn btn-primary" onclick="deleteMyTemplate(${template.id})" style="padding: 6px 12px; font-size: 12px; margin: 2px; background: var(--danger);">
                                        <i class="fas fa-trash"></i>删除
                                    </button>
                                </td>
                            </tr>
                        `;
                        }).join('');
                    }
                    
                    document.getElementById('my-templates-page-info').textContent = `第 ${myTemplatesCurrentPage} 页 / 共 ${myTemplatesTotalPages} 页`;
                }
            } catch (error) {
                console.error('加载模板列表失败:', error);
                document.getElementById('my-templates-tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">加载失败</td></tr>';
            }
        }

        // 查看模板图片
          function viewTemplateImage(imagePath, templateName, templateData) {
              try {
                  // templateData 已经是对象，直接使用
                  openModal(imagePath, templateName, templateData);
              } catch (error) {
                  console.error('打开模板失败:', error);
                  openModal(imagePath, templateName, null);
              }
          }

        // 删除模板
        async function deleteMyTemplate(templateId) {
            if (!confirm('确定要删除这个模板吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/photo/template/${templateId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const result = await response.json();
                
                if (result.code === 200) {
                    showMessage('删除成功', 'success');
                    loadMyTemplates(myTemplatesCurrentPage);
                    loadTemplates();
                } else {
                    showMessage(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除模板失败:', error);
                showMessage('删除失败：' + error.message, 'error');
            }
        }

        // 我的模板分页
        function previousMyTemplatesPage() {
            if (myTemplatesCurrentPage > 1) {
                loadMyTemplates(myTemplatesCurrentPage - 1);
            }
        }

        function nextMyTemplatesPage() {
            if (myTemplatesCurrentPage < myTemplatesTotalPages) {
                loadMyTemplates(myTemplatesCurrentPage + 1);
            }
        }

        // 在切换到添加模板标签页时加载我的模板
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            originalSwitchTab(tab);
            if (tab === 'add-template' && isLoggedIn) {
                loadMyTemplates(1);
            }
        };

        // 打开修改密码模态框
        function openChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.add('show');
            // 清空表单
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            // 清空提示信息
            const messageDiv = document.getElementById('change-password-message');
            messageDiv.style.display = 'none';
        }

        // 关闭修改密码模态框
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.remove('show');
            // 清空表单
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            // 清空提示信息
            const messageDiv = document.getElementById('change-password-message');
            messageDiv.style.display = 'none';
        }

        // 显示修改密码提示信息
        function showChangePasswordMessage(text, type) {
            const messageDiv = document.getElementById('change-password-message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            // 错误信息3秒后自动隐藏
            if (type === 'error') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // 点击模态框背景关闭
        document.getElementById('changePasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChangePasswordModal();
            }
        });

        // 提交修改密码
        async function submitChangePassword() {
            const oldPassword = document.getElementById('old-password').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();

            // 验证表单 - 按照标准修改密码流程
            if (!oldPassword) {
                showChangePasswordMessage('请输入原密码', 'error');
                return;
            }

            if (!newPassword) {
                showChangePasswordMessage('请输入新密码', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showChangePasswordMessage('新密码至少需要8个字符', 'error');
                return;
            }

            if (!confirmPassword) {
                showChangePasswordMessage('请输入确认密码', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showChangePasswordMessage('两次输入的密码不一致', 'error');
                return;
            }

            if (oldPassword === newPassword) {
                showChangePasswordMessage('新密码不能与原密码相同', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> 修改中...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        oldPassword: oldPassword,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                const result = await response.json();

                if (result.code === 200) {
                    // 显示加载中的提示
                    showChangePasswordMessage('密码修改成功，正在处理...', 'success');
                    
                    // 延迟后清除token并刷新页面
                    setTimeout(() => {
                        // 修改密码成功，清除token使其失效
                        localStorage.removeItem('token');
                        localStorage.removeItem('username');
                        localStorage.removeItem('role');
                        token = null;
                        
                        // 关闭模态框
                        closeChangePasswordModal();
                        
                        // 显示最终成功提示
                        showMessage('密码已修改，请使用新密码重新登录', 'success');
                        
                        // 再延迟后刷新页面
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }, 1500);
                } else {
                    showChangePasswordMessage(result.message || '密码修改失败', 'error');
                }
            } catch (error) {
                console.error('修改密码错误:', error);
                showChangePasswordMessage('修改密码失败：' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>