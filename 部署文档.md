# Photo Generate 项目部署文档

## 项目信息
- 项目名称：Photo Generate（图片文字合成系统）
- 服务器：Ubuntu 22.04
- 公网IP：156.238.232.101
- 部署路径：/usr/local/photo_generate/photo_generate
- 部署日期：2026-02-02

---

## 一、环境准备

### 1.1 系统信息
- 操作系统：Ubuntu 22.04
- Java版本：1.8.0_472
- MySQL版本：8.0.36
- Nginx版本：1.20.2

### 1.2 安装必要软件

#### 安装Java
```bash
sudo apt update
sudo apt install openjdk-8-jdk -y
java -version
```

#### 安装MySQL
```bash
sudo apt install mysql-server -y
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### 安装编译工具（用于编译nginx）
```bash
sudo apt install build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev -y
```

#### 安装screen（用于后台运行）
```bash
sudo apt install screen -y
```

---

## 二、项目部署

### 2.1 上传项目文件
将项目文件上传到服务器：`/usr/local/photo_generate/photo_generate`

项目结构：
```
/usr/local/photo_generate/photo_generate/
├── target/
│   ├── photo-generate-1.0.0.jar
│   └── classes/
│       ├── sql/
│       │   └── init.sql
│       └── templates/
│           ├── index.html
│           ├── login.html
│           └── register.html
├── uploads/
├── templates/
└── exports/
```

### 2.2 数据库配置

#### 创建数据库
```bash
sudo mysql
```

```sql
CREATE DATABASE photo_generate CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;
```

#### 导入数据库表结构
```bash
mysql -u root -p photo_generate < /usr/local/photo_generate/photo_generate/target/classes/sql/init.sql
```

#### 验证表是否创建成功
```bash
sudo mysql -e "USE photo_generate; SHOW TABLES;"
```

---

## 三、Nginx部署

### 3.1 下载并编译Nginx

#### 下载nginx源码
```bash
cd /usr/local/photo_generate/photo_generate
wget http://nginx.org/download/nginx-1.20.2.tar.gz
tar -zxvf nginx-1.20.2.tar.gz
```

#### 编译安装
```bash
cd nginx-1.20.2
./configure --prefix=/usr/local/photo_generate/photo_generate/nginx-1.20.2
make
```

#### 复制nginx可执行文件
```bash
cp objs/nginx sbin/nginx
```

### 3.2 配置Nginx

#### 创建配置文件
```bash
nano /usr/local/photo_generate/photo_generate/nginx-1.20.2/conf/nginx.conf
```

#### 配置文件内容
```nginx
user root;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    upstream webservers {
        server 127.0.0.1:8080 weight=90;
    }

    server {
        listen       80;
        server_name  156.238.232.101;

        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # 反向代理API请求
        location /api/ {
            proxy_pass   http://localhost:8080/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Requested-With $http_x_requested_with;
        }

        # 静态资源：上传的文件
        location /uploads/ {
            alias   ../uploads/;
        }

        # 静态资源：导出的文件
        location /exports/ {
            alias   ../exports/;
        }

        # 静态资源：模板文件
        location /templates/ {
            alias   ../templates/;
        }
    }
}
```

#### 复制其他配置文件
```bash
cp /usr/local/photo_generate/photo_generate/nginx-1.20.2（1）/conf/mime.types /usr/local/photo_generate/photo_generate/nginx-1.20.2/conf/mime.types
```

### 3.3 准备静态文件

#### 创建必要目录
```bash
cd /usr/local/photo_generate/photo_generate/nginx-1.20.2
mkdir -p logs
mkdir -p html
mkdir -p /usr/local/photo_generate/photo_generate/exports
```

#### 复制HTML文件
```bash
cp /usr/local/photo_generate/photo_generate/nginx-1.20.2（1）/html/* /usr/local/photo_generate/photo_generate/nginx-1.20.2/html/
```

### 3.4 启动Nginx

#### 使用screen启动（后台运行）
```bash
screen -S nginx
cd /usr/local/photo_generate/photo_generate/nginx-1.20.2
./sbin/nginx
# 按Ctrl+A，然后按D退出screen
```

#### 验证nginx状态
```bash
ps aux | grep nginx
curl http://156.238.232.101
```

---

## 四、Java应用部署

### 4.1 使用systemd管理服务（推荐）

#### 创建systemd服务文件
```bash
sudo nano /etc/systemd/system/photo-app.service
```

#### 服务文件内容
```ini
[Unit]
Description=Photo Generate Application
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/usr/local/photo_generate/photo_generate
ExecStart=/usr/bin/java -Duser.timezone=Asia/Shanghai -jar /usr/local/photo_generate/photo_generate/target/photo-generate-1.0.0.jar
Restart=always
RestartSec=10
StandardOutput=append:/var/log/photo-app.log
StandardError=append:/var/log/photo-app-error.log

[Install]
WantedBy=multi-user.target
```

#### 启动服务
```bash
sudo systemctl daemon-reload
sudo systemctl start photo-app
sudo systemctl enable photo-app
```

#### 查看服务状态
```bash
sudo systemctl status photo-app
```

#### 查看日志
```bash
sudo journalctl -u photo-app -f
```

### 4.2 服务管理命令

```bash
# 重启服务
sudo systemctl restart photo-app

# 停止服务
sudo systemctl stop photo-app

# 查看服务状态
sudo systemctl status photo-app

# 查看实时日志
sudo journalctl -u photo-app -f
```

---

## 五、系统配置

### 5.1 配置时区

#### 设置时区为中国上海时间
```bash
sudo timedatectl set-timezone Asia/Shanghai
```

#### 验证时区
```bash
timedatectl
date
```

### 5.2 安装中文字体（解决图片文字乱码）

#### 安装中文字体包
```bash
sudo apt update
sudo apt install fonts-wqy-microhei fonts-wqy-zenhei fonts-noto-cjk -y
sudo apt install fontconfig -y
```

#### 刷新字体缓存
```bash
fc-cache -fv
```

#### 验证字体安装
```bash
fc-list :lang=zh
```

#### 重启Java服务
```bash
sudo systemctl restart photo-app
```

### 5.3 开放防火墙端口

```bash
sudo ufw allow 80
sudo ufw allow 8080
sudo ufw status
```

---

## 六、常见问题及解决方案

### 6.1 Nginx相关

#### 问题1：访问静态资源404
**原因**：nginx配置中的路径不正确，使用了相对路径但nginx工作目录不对

**解决方案**：
- 使用绝对路径配置静态资源
- 或者确保从正确的目录启动nginx

```nginx
# 使用绝对路径
location /uploads/ {
    alias   /usr/local/photo_generate/photo_generate/uploads/;
}
```

#### 问题2：nginx编译安装失败
**原因**：在源码目录中执行make install导致文件冲突

**解决方案**：
```bash
# 直接使用编译好的nginx
cp objs/nginx sbin/nginx
```

### 6.2 Java应用相关

#### 问题1：SSH断开后Java服务停止
**原因**：使用screen但没有正确detach，或者直接关闭终端

**解决方案**：
- 使用systemd管理服务（推荐）
- 或者正确使用screen：按Ctrl+A，然后按D退出

#### 问题2：数据库连接失败
**原因**：数据库不存在或用户权限不足

**解决方案**：
```bash
# 创建数据库
sudo mysql -e "CREATE DATABASE photo_generate CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 导入表结构
mysql -u root -p photo_generate < /path/to/init.sql
```

#### 问题3：图片文字乱码
**原因**：Linux系统缺少中文字体

**解决方案**：
```bash
# 安装中文字体
sudo apt install fonts-wqy-microhei fonts-wqy-zenhei fonts-noto-cjk -y
fc-cache -fv
sudo systemctl restart photo-app
```

#### 问题4：时间显示不正确
**原因**：系统时区设置不正确

**解决方案**：
```bash
# 设置系统时区
sudo timedatectl set-timezone Asia/Shanghai

# 在Java启动参数中指定时区
ExecStart=/usr/bin/java -Duser.timezone=Asia/Shanghai -jar ...
```

### 6.3 MySQL相关

#### 问题1：MySQL root用户无法登录
**原因**：MySQL 8.0默认使用auth_socket插件

**解决方案**：
```bash
sudo mysql  # 使用sudo登录
```

#### 问题2：导入SQL文件失败
**原因**：数据库不存在或权限不足

**解决方案**：
```bash
# 先创建数据库
sudo mysql -e "CREATE DATABASE photo_generate CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 再导入
mysql -u root -p photo_generate < /path/to/init.sql
```

---

## 七、部署检查清单

### 7.1 部署前检查
- [ ] Java环境已安装
- [ ] MySQL已安装并启动
- [ ] 项目文件已上传
- [ ] 数据库已创建并导入表结构

### 7.2 部署后检查
- [ ] Nginx已启动并正常运行
- [ ] Java应用已启动并正常运行
- [ ] 系统时区已设置为Asia/Shanghai
- [ ] 中文字体已安装
- [ ] 防火墙端口已开放
- [ ] 可以通过公网IP访问应用
- [ ] 图片生成功能正常
- [ ] 文字显示正常（无乱码）
- [ ] 时间显示正确

### 7.3 功能测试
- [ ] 访问 http://156.238.232.101 可以看到首页
- [ ] 登录功能正常
- [ ] 注册功能正常
- [ ] 图片生成功能正常
- [ ] 图片下载功能正常
- [ ] 使用记录显示正常
- [ ] 时间显示正确

---

## 八、维护命令

### 8.1 日常维护

```bash
# 查看系统资源使用情况
htop

# 查看磁盘使用情况
df -h

# 查看内存使用情况
free -h

# 查看服务状态
sudo systemctl status photo-app
ps aux | grep nginx

# 查看日志
sudo journalctl -u photo-app -f
tail -f /usr/local/photo_generate/photo_generate/nginx-1.20.2/logs/access.log
tail -f /usr/local/photo_generate/photo_generate/nginx-1.20.2/logs/error.log
```

### 8.2 备份

```bash
# 备份数据库
mysqldump -u root -p photo_generate > photo_generate_backup_$(date +%Y%m%d).sql

# 备份上传的文件
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz /usr/local/photo_generate/photo_generate/uploads/
```

### 8.3 更新部署

```bash
# 1. 停止服务
sudo systemctl stop photo-app

# 2. 备份旧版本
cp /usr/local/photo_generate/photo_generate/target/photo-generate-1.0.0.jar /usr/local/photo_generate/photo_generate/target/photo-generate-1.0.0.jar.bak

# 3. 上传新版本jar包

# 4. 启动服务
sudo systemctl start photo-app

# 5. 查看日志确认启动成功
sudo journalctl -u photo-app -f
```

---

## 九、联系方式

如有问题，请联系技术支持。

---

## 十、附录

### 10.1 项目端口说明
- 80：Nginx HTTP服务
- 8080：Java应用服务
- 3306：MySQL数据库

### 10.2 重要路径
- 项目根目录：/usr/local/photo_generate/photo_generate
- Nginx目录：/usr/local/photo_generate/photo_generate/nginx-1.20.2
- 上传文件目录：/usr/local/photo_generate/photo_generate/uploads
- 导出文件目录：/usr/local/photo_generate/photo_generate/exports
- 模板文件目录：/usr/local/photo_generate/photo_generate/templates
- Nginx日志：/usr/local/photo_generate/photo_generate/nginx-1.20.2/logs/
- 应用日志：/var/log/photo-app.log

### 10.3 服务管理
- Nginx管理：使用screen
- Java应用管理：使用systemd

---

**文档版本**：v1.0  
**最后更新**：2026-02-02  
**维护人员**：技术团队